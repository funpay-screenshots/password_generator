<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Password Generator</title>

<style>
:root {
    --bg: #f5f5f7;
    --card: #ffffff;
    --text: #111;
    --muted: #f0f0f3;
    --border: #ddd;
    --button: #000;
    --button-text: #fff;
}

.dark {
    --bg: #0f1115;
    --card: #1a1d23;
    --text: #f5f5f7;
    --muted: #2a2f38;
    --border: #333;
    --button: #ffffff;
    --button-text: #000;
}

body {
    margin: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: var(--bg);
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    transition: 0.25s ease;
}

.card {
    position: relative;
    background: var(--card);
    padding: 40px;
    border-radius: 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    width: 360px;
    text-align: center;
    transition: 0.25s ease;
}

.theme-toggle {
    position: absolute;
    top: 18px;
    right: 18px;
    background: none;
    border: none;
    cursor: pointer;
}

h1 {
    margin-bottom: 24px;
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
}

.length-label {
    color: var(--text);
}

.number-input-wrap {
    display: inline-flex;
    align-items: center;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--card);
    padding: 2px 3px;
    gap: 0px;
}

.number-input-wrap input[type="number"] {
    width: 24px;
    padding: 6px 0;
    border: none;
    text-align: center;
    font-size: 15px;
    background: transparent;
    color: var(--text);
    -moz-appearance: textfield;
    outline: none;
}

.number-input-wrap input[type="number"]::-webkit-inner-spin-button,
.number-input-wrap input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.num-btn {
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 16px;
    width: 26px;
    height: 26px;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
    flex-shrink: 0;
}

.num-btn:hover {
    background: var(--muted);
}

.password-container {
    position: relative;
    margin-top: 20px;
    width: calc(100% / 1.5);
    margin-left: auto;
    margin-right: auto;
}

.password {
    font-size: 18px;
    background: var(--muted);
    padding: 14px 50px 14px 14px;
    border-radius: 16px;
    word-break: break-all;
    user-select: all;
    color: var(--text);
    min-height: 24px;
    display: flex;
    align-items: center;
}

.copy-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    background: var(--card);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: 0.2s ease;
}

.copy-btn:hover {
    transform: translateY(-50%) scale(1.08);
}

.copy-btn svg {
    width: 18px;
    height: 18px;
    fill: var(--text);
    stroke: var(--text);
}

button.generate {
    margin-top: 20px;
    padding: 12px 20px;
    border: none;
    border-radius: 20px;
    font-size: 15px;
    cursor: pointer;
    background: var(--button);
    color: var(--button-text);
    transition: 0.2s;
}

button.generate:hover {
    opacity: 0.85;
}

.theme-toggle svg {
    width: 18px;
    height: 18px;
    fill: var(--text);
}
</style>
</head>

<body class="dark">

<div class="card">
    <button class="theme-toggle" onclick="toggleTheme()">
        <svg id="themeIcon" viewBox="0 0 24 24"></svg>
    </button>

    <h1>Генератор паролей</h1>

    <div>
        <span class="length-label">Длина:</span>
        <span class="number-input-wrap">
            <button class="num-btn" onclick="changeLength(-1)">−</button>
            <input type="number" id="length" value="10" min="6" max="64">
            <button class="num-btn" onclick="changeLength(1)">+</button>
        </span>
    </div>

    <div class="password-container">
        <div class="password" id="result"></div>
        <button class="copy-btn" onclick="copyPassword()">
            <svg id="copyIcon" viewBox="0 0 24 24">
                <path fill="var(--text)" stroke="none" d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/>
            </svg>
        </button>
    </div>

    <button class="generate" onclick="generatePassword()">Сгенерировать</button>
</div>

<script>
function changeLength(delta) {
    const input = document.getElementById("length");
    let val = parseInt(input.value) + delta;
    if (val < 6) val = 6;
    if (val > 64) val = 64;
    input.value = val;
}

function generatePassword() {
    const lengthInput = document.getElementById("length");
    let length = parseInt(lengthInput.value);
    if (length < 6) length = 6;

    const upper = "ABCDEFGHKNOPQRSTUVWXYZ";
    const lower = "abcdefghkmnopqrstuvwxyz";
    const digits = "0123456789";
    const specials = "&#%$@";
    const forbiddenEdge = "VTYJ";

    const allMiddle = upper + lower + digits + specials;

    function randomChar(set) {
        return set[Math.floor(Math.random() * set.length)];
    }

    function isValid(password) {
        if (!/[A-Z]/.test(password)) return false;
        if (!/[a-z]/.test(password)) return false;
        if (!/[0-9]/.test(password)) return false;
        if (!/[&#%$@?]/.test(password)) return false;

        const digitCount = (password.match(/[0-9]/g) || []).length;
        if (digitCount < 2) return false;
        if (digitCount > 2) return false;

        const lowerCount = (password.match(/[a-z]/g) || []).length;
        if (lowerCount < 2) return false;

        const upperCount = (password.match(/[A-Z]/g) || []).length;
        if (upperCount > Math.floor(length * 2 / 3)) return false;

        const specMatches = password.match(/[&#%$@]/g) || [];
        if (specMatches.length > 2) return false;

        if (specMatches.length !== new Set(specMatches).size) return false;

        for (let i = 1; i < password.length; i++) {
            if (specials.includes(password[i]) && specials.includes(password[i - 1])) return false;
        }

        for (let i = 1; i < password.length; i++) {
            if (password[i] === password[i - 1]) return false;
        }

        if (forbiddenEdge.includes(password[0])) return false;
        if (forbiddenEdge.includes(password[password.length - 1])) return false;

        return true;
    }

    let password = "";

    do {
        let chars = [];
        let usedSpecials = new Set();
        let digitCount = 0;

        // Первый символ — заглавная, не из forbiddenEdge
        let firstChar;
        do {
            firstChar = randomChar(upper);
        } while (forbiddenEdge.includes(firstChar));
        chars.push(firstChar);

        // Обязательные символы: ровно 2 цифры, 1 спецсимвол, 2 строчных
        const requiredSpec = randomChar(specials);
        usedSpecials.add(requiredSpec);

        const d1 = randomChar(digits);
        let d2;
        do { d2 = randomChar(digits); } while (d2 === d1);

        const required = [
            d1,
            d2,
            requiredSpec,
            randomChar(lower),
            randomChar(lower),
        ];

        // Перемешиваем обязательные символы
        for (let i = required.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [required[i], required[j]] = [required[j], required[i]];
        }

        // Вставляем обязательные символы
        for (const req of required) {
            if (chars.length >= length - 1) break;

            if (digits.includes(req)) {
                if (digitCount >= 2) {
                    let fallback;
                    do {
                        fallback = randomChar(upper + lower);
                    } while (fallback === chars[chars.length - 1]);
                    chars.push(fallback);
                    continue;
                }
                digitCount++;
            }

            if (specials.includes(req)) {
                if (usedSpecials.size >= 2 || specials.includes(chars[chars.length - 1])) {
                    let fallback;
                    do {
                        fallback = randomChar(upper + lower);
                    } while (fallback === chars[chars.length - 1]);
                    chars.push(fallback);
                    continue;
                }
                usedSpecials.add(req);
            }

            if (req === chars[chars.length - 1]) {
                let pad;
                do {
                    pad = randomChar(allMiddle);
                } while (
                    pad === chars[chars.length - 1] ||
                    (digits.includes(pad) && digitCount >= 2) ||
                    (specials.includes(pad) && (usedSpecials.size >= 2 || specials.includes(chars[chars.length - 1]))) ||
                    (specials.includes(pad) && usedSpecials.has(pad))
                );
                if (digits.includes(pad)) digitCount++;
                if (specials.includes(pad)) usedSpecials.add(pad);
                if (chars.length < length - 1) chars.push(pad);
            }

            if (chars.length < length - 1) chars.push(req);
        }

        // Заполняем оставшиеся позиции
        while (chars.length < length - 1) {
            let next;
            do {
                next = randomChar(allMiddle);

                if (digits.includes(next) && digitCount >= 2) continue;

                if (specials.includes(next)) {
                    if (usedSpecials.size >= 2) continue;
                    if (specials.includes(chars[chars.length - 1])) continue;
                    if (usedSpecials.has(next)) continue;
                }

                if (next === chars[chars.length - 1]) continue;

                break;
            } while (true);

            if (digits.includes(next)) digitCount++;
            if (specials.includes(next)) usedSpecials.add(next);
            chars.push(next);
        }

        // Последний символ — заглавная, не повторяет предыдущий и не forbidden
        let lastChar;
        do {
            lastChar = randomChar(upper);
        } while (
            lastChar === chars[chars.length - 1] ||
            forbiddenEdge.includes(lastChar)
        );

        chars.push(lastChar);
        password = chars.join("");

    } while (!isValid(password));

    document.getElementById("result").textContent = password;
}

function copyPassword() {
    const text = document.getElementById("result").textContent;
    if (!text) return;
    navigator.clipboard.writeText(text);

    const icon = document.getElementById("copyIcon");
    icon.innerHTML = `<polyline points="20 6 9 17 4 12" style="stroke: var(--text); stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round;"/>`;

    setTimeout(() => {
        icon.innerHTML = `<path fill="var(--text)" stroke="none" d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/>`;
    }, 1500);
}

function toggleTheme() {
    document.body.classList.toggle("dark");
    updateIcon();
}

function updateIcon() {
    const icon = document.getElementById("themeIcon");
    if (document.body.classList.contains("dark")) {
        icon.innerHTML = `<path d="M21 12.79A9 9 0 0 1 11.21 3 7 7 0 1 0 21 12.79z"/>`;
    } else {
        icon.innerHTML = `
            <circle cx="12" cy="12" r="5"/>
            <g>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </g>
        `;
        icon.querySelectorAll("line").forEach(l => {
            l.setAttribute("stroke", "currentColor");
            l.setAttribute("stroke-width", "2");
        });
    }
}

updateIcon();
</script>

</body>
</html>
